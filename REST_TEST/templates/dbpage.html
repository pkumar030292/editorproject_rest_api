<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DB Management Admin Panel</title>
<style>
    body { font-family: Arial, sans-serif; background: #f4f6f8; margin:0; padding:0; }
    h2 { background: #2f4050; color: #fff; margin:0; padding:15px 20px; border-radius: 5px 5px 0 0; }
    .section { border-radius:5px; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin:20px; padding:20px; }
    label { display:block; margin:10px 0 5px; font-weight:600; }
    input, select, button { padding:8px; width:100%; margin-bottom:10px; border-radius:4px; border:1px solid #ccc; }
    button { background:#2f4050; color:#fff; border:none; cursor:pointer; transition:0.2s; }
    button:hover:not(:disabled) { background:#1f2a36; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    table { border-collapse: collapse; width:100%; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; }
    th { background:#e9ecef; }
    .hidden { display:none; }
</style>
</head>
<body>

<h2>VM Connection</h2>
<div class="section">
    <label>VM IP:</label>
    <input type="text" id="vm-ip" value="192.168.56.101">
    <label>VM User:</label>
    <input type="text" id="vm-user" value="cisco">
    <label>VM Password:</label>
    <input type="password" id="vm-password">
    <button id="connect-vm-btn" onclick="connectVM()">Connect VM</button>
    <p id="vm-status"></p>
</div>

<h2>DB Connection</h2>
<div class="section hidden" id="db-section">
    <label>DB Host:</label>
    <input type="text" id="db-host">
    <label>DB Port:</label>
    <input type="number" id="db-port" value="3306">
    <label>DB User:</label>
    <input type="text" id="db-user">
    <label>DB Password:</label>
    <input type="password" id="db-password">
    <button id="connect-db-btn" onclick="connectDB()" disabled>Connect DB</button>
    <p id="db-status"></p>
</div>

<h2>Databases & Tables</h2>
<div class="section hidden" id="db-details-section">
    <label>Select Database:</label>
    <select id="db-list"></select>
    <button onclick="deleteDB()" id="delete-db-btn" disabled>Delete Database</button>

    <label>Select Table:</label>
    <select id="table-list"></select>
    <button onclick="deleteTable()" id="delete-table-btn" disabled>Delete Table</button>

    <h3>Table Details:</h3>
    <div id="table-details"></div>

    <h3>Table Data:</h3>
    <table id="table-data" style="display:none;">
        <thead id="table-head"></thead>
        <tbody id="table-body"></tbody>
    </table>

    <h3>Insert New Row:</h3>
    <div id="dynamic-row-form"></div>
</div>

<h2>Create Database</h2>
<div class="section hidden" id="create-db-section">
    <label>New DB Name:</label>
    <input type="text" id="new-db-name">
    <button id="create-db-btn" onclick="createDB()" disabled>Create DB</button>
    <p id="create-db-status"></p>
</div>

<h2>Create Table</h2>
<div class="section hidden" id="create-table-section">
    <label>Table Name:</label>
    <input type="text" id="new-table-name">
    <label>Columns (name:type, comma-separated):</label>
    <input type="text" id="table-columns" placeholder="id:int,name:varchar(255),salary:decimal(10,2)">
    <button id="create-table-btn" onclick="createTable()" disabled>Create Table</button>
    <p id="create-table-status"></p>
</div>

<script>
let vmConnected = false;
let dbConnected = false;

// -------- VM Connection --------
function connectVM() {
    const payload = {
        ip: document.getElementById("vm-ip").value,
        user: document.getElementById("vm-user").value,
        password: document.getElementById("vm-password").value
    };
    fetch("/connectVM", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("vm-status").innerText = data.message ?? data.error ?? "Unknown response!";
        if(data.success){
            vmConnected = true;
            document.getElementById("db-section").classList.remove("hidden");
            document.getElementById("connect-db-btn").disabled = false;
        }
    })
    .catch(err => alert("VM Connection Error: " + (err.message || err)));
}

// -------- DB Connection --------
function connectDB() {
    if(!vmConnected) return alert("Connect to VM first!");
    const payload = {
        host: document.getElementById("db-host").value,
        port: parseInt(document.getElementById("db-port").value),
        user: document.getElementById("db-user").value,
        password: document.getElementById("db-password").value
    };
    fetch("/connect-db", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("db-status").innerText = data.success ? "Connected successfully!" : (data.message ?? data.error ?? "Connection failed!");
        if(data.success){
            dbConnected = true;
            const dbList = document.getElementById("db-list");
            dbList.innerHTML = "";
            data.databases.forEach(db=>{
                const option = document.createElement("option");
                option.value = db; option.text = db;
                dbList.add(option);
            });
            document.getElementById("db-details-section").classList.remove("hidden");
            document.getElementById("create-db-section").classList.remove("hidden");
            document.getElementById("create-table-section").classList.remove("hidden");

            document.getElementById("delete-db-btn").disabled = false;
            document.getElementById("delete-table-btn").disabled = false;
            document.getElementById("create-db-btn").disabled = false;
            document.getElementById("create-table-btn").disabled = false;

            loadTables();
        }
    })
    .catch(err => alert("DB Connection Error: " + (err.message || err)));
}

// -------- Load Tables --------
function loadTables() {
    const dbName = document.getElementById("db-list").value;
    if(!dbName) return;
    fetch(`/tables?db_name=${dbName}`)
    .then(res => res.json())
    .then(data => {
        const tableList = document.getElementById("table-list");
        tableList.innerHTML = "";
        data.tables.forEach(tbl=>{
            const option=document.createElement("option");
            option.value=tbl; option.text=tbl; tableList.add(option);
        });
        if(data.tables.length>0) showTableDetails();
        else {
            document.getElementById("table-details").innerText="No tables";
            document.getElementById("table-data").style.display="none";
        }
    })
    .catch(err => alert("Load Tables Error: " + (err.message || err)));
}

// -------- Show Table Details + Rows --------
function showTableDetails() {
    const dbName = document.getElementById("db-list").value;
    const tableName = document.getElementById("table-list").value;
    if(!tableName) return;

    fetch(`/table-details?db_name=${dbName}&table_name=${tableName}`)
    .then(res => res.json())
    .then(data => {
        const container = document.getElementById("table-details");
        container.innerHTML = "";

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        ["Field","Type","Null","Key","Default","Extra"].forEach(h=>{
            const th = document.createElement("th"); th.innerText=h; headerRow.appendChild(th);
        });
        thead.appendChild(headerRow); table.appendChild(thead);

        const tbody = document.createElement("tbody");
        data.details.forEach(col=>{
            const row = document.createElement("tr");
            ["Field","Type","Null","Key","Default","Extra"].forEach(k=>{
                const td=document.createElement("td"); td.innerText=col[k]??""; row.appendChild(td);
            });
            tbody.appendChild(row);
        });
        table.appendChild(tbody);
        container.appendChild(table);

        generateRowInput(data.details);

        fetch(`/table-data?db_name=${dbName}&table_name=${tableName}`)
        .then(res=>res.json())
        .then(tblData=>{
            const dataTable = document.getElementById("table-data");
            const tHead = document.getElementById("table-head");
            const tBody = document.getElementById("table-body");
            tBody.innerHTML = ""; tHead.innerHTML = "";

            if(tblData.success && tblData.rows.length>0){
                dataTable.style.display="table";
                const headers = Object.keys(tblData.rows[0]);
                tHead.innerHTML = "<tr>"+headers.map(h=>`<th>${h}</th>`).join("")+"</tr>";
                tBody.innerHTML = tblData.rows.map(r=>"<tr>"+headers.map(h=>`<td>${r[h]}</td>`).join("")+"</tr>").join("");
            } else dataTable.style.display="none";
        })
        .catch(err => alert("Load Table Data Error: " + (err.message || err)));
    })
    .catch(err => alert("Table Details Error: " + (err.message || err)));
}

// -------- Generate Insert Row Form --------
function generateRowInput(details){
    const container=document.getElementById("dynamic-row-form");
    container.innerHTML="";
    const form=document.createElement("div");
    details.forEach(col=>{
        if(col.Extra==="auto_increment") return;
        const label=document.createElement("label"); label.innerText=`${col.Field} (${col.Type})`;
        const input=document.createElement("input"); input.id=`col-${col.Field}`; input.placeholder=`Enter ${col.Field}`;
        form.appendChild(label); form.appendChild(input);
    });
    const btn=document.createElement("button"); btn.innerText="Insert Row"; btn.onclick=insertRow;
    form.appendChild(btn); container.appendChild(form);
}

// -------- Insert Row --------
function insertRow(){
    if(!dbConnected) return alert("Connect to DB first!");
    const dbName=document.getElementById("db-list").value;
    const tableName=document.getElementById("table-list").value;
    const container=document.getElementById("dynamic-row-form");
    const inputs = container.querySelectorAll("input");
    const rowData={};
    inputs.forEach(input=>rowData[input.id.replace("col-","")]=input.value);

    fetch("/insert-row",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({db_name:dbName, table_name:tableName, row_data:rowData})
    })
    .then(res=>res.json())
    .then(data=>{
        const msg = data.message ?? data.error ?? "Unknown error!";
        alert(msg);
        if(data.success) showTableDetails();
    })
    .catch(err => alert("Insert Row Error: " + (err.message || err)));
}

// -------- Create DB --------
function createDB(){
    const dbName=document.getElementById("new-db-name").value;
    if(!dbName) return;
    fetch("/create-db",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({db_name:dbName})
    })
    .then(res=>res.json())
    .then(data=>{
        const msg = data.message ?? data.error ?? "Unknown error!";
        document.getElementById("create-db-status").innerText = msg;
        if(data.success) connectDB();
    })
    .catch(err => alert("Create DB Error: " + (err.message || err)));
}

// -------- Create Table --------
function createTable(){
    const dbName=document.getElementById("db-list").value;
    const tableName=document.getElementById("new-table-name").value;
    const columns=document.getElementById("table-columns").value;
    if(!tableName || !columns) return alert("Table name & columns required");
    fetch("/create-table",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({db_name:dbName, table_name:tableName, columns:columns})
    })
    .then(res=>res.json())
    .then(data=>{
        const msg = data.message ?? data.error ?? "Unknown error!";
        document.getElementById("create-table-status").innerText = msg;
        if(data.success) loadTables();
    })
    .catch(err => alert("Create Table Error: " + (err.message || err)));
}

// -------- Delete DB --------
function deleteDB(){
    const dbName = document.getElementById("db-list").value;
    if(!dbName || !confirm(`Delete DB "${dbName}"?`)) return;

    fetch("/delete-db", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({db_name: dbName})
    })
    .then(res => res.json())
    .then(data => {
        const msg = data.message ?? data.error ?? "Unknown error!";
        alert(msg);
        if(data.success) connectDB();
    })
    .catch(err => alert("Delete DB Error: " + (err.message || err)));
}

// -------- Delete Table --------
function deleteTable(){
    const dbName=document.getElementById("db-list").value;
    const tableName=document.getElementById("table-list").value;
    if(!tableName || !confirm(`Delete Table "${tableName}"?`)) return;

    fetch("/delete-table",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({db_name:dbName, table_name:tableName})
    })
    .then(res=>res.json())
    .then(data=>{
        const msg = data.message ?? data.error ?? "Unknown error!";
        alert(msg);
        if(data.success) loadTables();
    })
    .catch(err => alert("Delete Table Error: " + (err.message || err)));
}
</script>

</body>
</html>
